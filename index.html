<html>
<body>

    <div id="main">
        <h1>Main Page</h1>
        This is the main page...
        Below we try to open an IFRAME pointing to a sheet from an app running in Qlik Cloud.
        <hr>
        <h1>Qlik Cloud content</h1>
        <iframe id='qlik_frame' style='border:none;width:100%;height:900px;'></iframe>
    </div>

    <script>

        //    CONFIGURATION

        const TENANT = 'bies.eu.qlikcloud.com';
        const JWTENDPOINT = '/token';
        const WEBINTEGRATIONID = 'q53JKnG6HxRKeSeDdUK88_pDo5mmGUQC' //DbN1BlXAMCfX2MwVbsrzrFuK848gKXPm';
        const APPID = 'c8133385-b9bf-4b27-af62-1faf52db8f1a'
        const SHEETID = 'XkgjPf';
        //    MAIN

        // try {
        //     const { tenantDomain, qlikWebIntegrationId, appId, objId, currentLoginType, loginTypes } = await fetch("config").then((resp) => resp.json());
        // } catch (error) {
        //     console.error(error);
        // }

        (async function main() {            
            const isLoggedIn = await qlikLogin();
            renderSingleIframe('qlik_frame', APPID, SHEETID);
        })();

        //    LOGIN

        async function qlikLogin() {
            const loggedIn = await checkLoggedIn();
            if (loggedIn.status !== 200) {
                const tokenRes = await (await getJWTToken(JWTENDPOINT)).json();
                const loginRes = await jwtLogin(tokenRes.body);
                if (loginRes.status != 200) {
                    const message = 'Something went wrong while logging in.';
                    alert(message);
                    throw new Error(message);
                }
                const recheckLoggedIn = await checkLoggedIn();
                if (recheckLoggedIn.status !== 200) {
                    const message = 'Third-party cookies are not enabled in your browser settings and/or browser mode.';
                    alert(message);
                    throw new Error(message);
                }
            }
            console.log('Logged in!');
            return true;
        }

        async function checkLoggedIn() {
            return await fetch(`https://${TENANT}/api/v1/users/me`, {
                mode: 'cors',
                credentials: 'include',
                headers: {
                    'qlik-web-integration-id': WEBINTEGRATIONID
                },
            })
        }

        async function getJWTToken(jwtEndpoint) {
            return await fetch(jwtEndpoint, {
                // mode: 'cors',
                method: 'GET'
            })
        }

        async function jwtLogin(token) {
            const authHeader = `Bearer ${token}`;
            return await fetch(`https://${TENANT}/login/jwt-session?qlik-web-integration-id=${WEBINTEGRATIONID}`, {
                credentials: 'include',
                mode: 'cors',
                method: 'POST',
                headers: {
                    'Authorization': authHeader,
                    'qlik-web-integration-id': WEBINTEGRATIONID
                },
            })
        }      

         //    HELPER FUNCTION TO GENERATE IFRAME
         function renderSingleIframe(frameId, appId, sheetId) {
            const frameUrl = `https://${TENANT}/single/?appid=${appId}&sheet=${sheetId}&opt=ctxmenu,currsel`;
            document.getElementById(frameId).setAttribute('src', frameUrl);
        }
      

    </script>

</body>

</html>